# Obsidian è¯­éŸ³åŠ©æ‰‹æ’ä»¶ä½¿ç”¨è¯´æ˜æ–‡æ¡£

## ç›®å½•
- [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
- [ç›®å½•ç»“æ„](#ç›®å½•ç»“æ„)
- [æ ¸å¿ƒåŠŸèƒ½æ¨¡å—](#æ ¸å¿ƒåŠŸèƒ½æ¨¡å—)
- [è¿è¡Œç¯å¢ƒè¦æ±‚](#è¿è¡Œç¯å¢ƒè¦æ±‚)
- [å®‰è£…æ­¥éª¤](#å®‰è£…æ­¥éª¤)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [ä½¿ç”¨æ–¹æ³•](#ä½¿ç”¨æ–¹æ³•)
- [APIæ¥å£è¯´æ˜](#apiæ¥å£è¯´æ˜)
- [å¸¸è§é—®é¢˜è§£ç­”](#å¸¸è§é—®é¢˜è§£ç­”)
- [å¼€å‘è€…æŒ‡å—](#å¼€å‘è€…æŒ‡å—)

## é¡¹ç›®æ¦‚è¿°

**Obsidian è¯­éŸ³åŠ©æ‰‹æ’ä»¶** æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„è¯­éŸ³äº¤äº’æ’ä»¶ï¼Œä¸º Obsidian ç¬”è®°è½¯ä»¶æä¾›æ™ºèƒ½è¯­éŸ³åŠ©æ‰‹åŠŸèƒ½ã€‚è¯¥æ’ä»¶é›†æˆäº†è¯­éŸ³è¯†åˆ«ã€è¯­éŸ³åˆæˆã€è¯­éŸ³å”¤é†’å’Œå¤šç§å¤§è¯­è¨€æ¨¡å‹ï¼Œæ”¯æŒè‡ªç„¶è¯­è¨€å¯¹è¯ã€è¯­éŸ³å¬å†™ã€è¯­éŸ³æœ—è¯»ç­‰åŠŸèƒ½ã€‚

### ä¸»è¦ç‰¹æ€§
- ğŸ¤ **è¯­éŸ³è¯†åˆ«**ï¼šåŸºäºè®¯é£åœ¨çº¿ASRï¼Œæ”¯æŒå®æ—¶è¯­éŸ³è½¬æ–‡å­—
- ğŸ”Š **è¯­éŸ³åˆæˆ**ï¼šåŸºäºè®¯é£åœ¨çº¿TTSï¼Œæ”¯æŒå¤šç§éŸ³è‰²å’Œè¯­éŸ³å‚æ•°è°ƒèŠ‚
- ğŸ¯ **è¯­éŸ³å”¤é†’**ï¼šæ”¯æŒè‡ªå®šä¹‰å”¤é†’è¯ï¼Œå…æ‰‹åŠ¨æ¿€æ´»
- ğŸ¤– **å¤šæ¨¡å‹æ”¯æŒ**ï¼šé›†æˆGoogle AI Studioã€OpenRouterã€è®¯é£æ˜Ÿç«ç­‰å¤šç§å¤§è¯­è¨€æ¨¡å‹
- ğŸ“ **æ™ºèƒ½å¯¹è¯**ï¼šæ”¯æŒæŒç»­å¯¹è¯æ¨¡å¼å’Œè‡ªå®šä¹‰æç¤ºè¯
- âœï¸ **è¯­éŸ³å¬å†™**ï¼šæ”¯æŒè¿ç»­è¯­éŸ³å¬å†™ï¼Œè‡ªåŠ¨æ’å…¥ç¬”è®°
- ğŸ“– **è¯­éŸ³æœ—è¯»**ï¼šæ”¯æŒé€‰ä¸­æ–‡æœ¬çš„è¯­éŸ³æœ—è¯»åŠŸèƒ½
- âš™ï¸ **é«˜åº¦å¯é…ç½®**ï¼šä¸°å¯Œçš„é…ç½®é€‰é¡¹ï¼Œæ»¡è¶³ä¸åŒä½¿ç”¨éœ€æ±‚

## ç›®å½•ç»“æ„

```
obsidian-yuhanbo-voice_assistant/
â”œâ”€â”€ main.ts                    # ä¸»æ’ä»¶æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½
â”œâ”€â”€ main.js                    # ç¼–è¯‘åçš„JavaScriptæ–‡ä»¶
â”œâ”€â”€ manifest.json              # æ’ä»¶æ¸…å•æ–‡ä»¶
â”œâ”€â”€ data.json                  # ç”¨æˆ·é…ç½®æ•°æ®æ–‡ä»¶
â”œâ”€â”€ package.json               # é¡¹ç›®ä¾èµ–å’Œè„šæœ¬é…ç½®
â”œâ”€â”€ package-lock.json          # ä¾èµ–ç‰ˆæœ¬é”å®šæ–‡ä»¶
â”œâ”€â”€ tsconfig.json              # TypeScriptç¼–è¯‘é…ç½®
â”œâ”€â”€ esbuild.config.mjs         # ESBuildæ‰“åŒ…é…ç½®
â”œâ”€â”€ styles.css                 # æ’ä»¶æ ·å¼æ–‡ä»¶
â”œâ”€â”€ version-bump.mjs           # ç‰ˆæœ¬æ›´æ–°è„šæœ¬
â”œâ”€â”€ versions.json              # ç‰ˆæœ¬å†å²è®°å½•
â”œâ”€â”€ .gitignore                 # Gitå¿½ç•¥æ–‡ä»¶é…ç½®
â””â”€â”€ README.md                  # é¡¹ç›®è¯´æ˜æ–‡ä»¶
```

## æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### 1. ä¸»æ’ä»¶ç±» (VoiceAssistantPlugin)
- **æ–‡ä»¶ä½ç½®**: `main.ts` (ç¬¬131è¡Œå¼€å§‹)
- **åŠŸèƒ½**: æ’ä»¶çš„æ ¸å¿ƒæ§åˆ¶å™¨ï¼Œç®¡ç†æ‰€æœ‰è¯­éŸ³åŠŸèƒ½
- **ä¸»è¦å±æ€§**:
  - `settings`: æ’ä»¶é…ç½®ç®¡ç†
  - `mediaRecorder`: éŸ³é¢‘å½•åˆ¶å™¨
  - `wakeMediaRecorder`: å”¤é†’ç›‘å¬å½•åˆ¶å™¨
  - `statusFloat`: çŠ¶æ€æµ®çª—æ˜¾ç¤º
  - `conversationHistory`: å¯¹è¯å†å²è®°å½•

### 2. è¯­éŸ³è¯†åˆ«æ¨¡å—
- **æ ¸å¿ƒæ–¹æ³•**: `speechToText()`, `xunfeiOnlineASR()`
- **åŠŸèƒ½**: å°†éŸ³é¢‘è½¬æ¢ä¸ºæ–‡å­—ï¼Œæ”¯æŒè®¯é£åœ¨çº¿ASR
- **è¾“å…¥**: éŸ³é¢‘Blobå¯¹è±¡
- **è¾“å‡º**: è¯†åˆ«çš„æ–‡å­—å­—ç¬¦ä¸²

### 3. è¯­éŸ³åˆæˆæ¨¡å—
- **æ ¸å¿ƒæ–¹æ³•**: `textToSpeech()`, `xunfeiOnlineTTS()`
- **åŠŸèƒ½**: å°†æ–‡å­—è½¬æ¢ä¸ºè¯­éŸ³å¹¶æ’­æ”¾
- **æ”¯æŒæ ¼å¼**: MP3éŸ³é¢‘æµ
- **å¯é…ç½®å‚æ•°**: éŸ³è‰²ã€è¯­é€Ÿã€éŸ³é‡ã€éŸ³è°ƒ

### 4. è¯­éŸ³å”¤é†’æ¨¡å—
- **æ ¸å¿ƒæ–¹æ³•**: `startWakeListening()`, `startWakeListeningLoop()`
- **åŠŸèƒ½**: æŒç»­ç›‘å¬é¢„è®¾å”¤é†’è¯ï¼Œè‡ªåŠ¨æ¿€æ´»å¯¹è¯
- **å”¤é†’è¯**: å¯è‡ªå®šä¹‰ï¼Œé»˜è®¤åŒ…å«"ä½ å¥½ï¼Œå°ä¸‰"ç­‰
- **æ£€æµ‹é—´éš”**: å¯é…ç½®ï¼Œé»˜è®¤900æ¯«ç§’

### 5. å¤§è¯­è¨€æ¨¡å‹é›†æˆ
- **æ”¯æŒçš„æ¨¡å‹**:
  - Google AI Studio (Geminiç³»åˆ—)
  - OpenRouter (GPTã€Claudeç­‰)
  - è®¯é£æ˜Ÿç« (Sparkç³»åˆ—)
  - è‡ªå®šä¹‰æ¨¡å‹
- **æ ¸å¿ƒæ–¹æ³•**: `callLLM()`, `callGoogleAI()`, `callOpenRouter()`, `callXunfeiSpark()`

### 6. å¯¹è¯ç®¡ç†æ¨¡å—
- **æŒç»­å¯¹è¯**: æ”¯æŒå¤šè½®å¯¹è¯ï¼Œè‡ªåŠ¨ç®¡ç†ä¸Šä¸‹æ–‡
- **å¯¹è¯å†å²**: è‡ªåŠ¨ä¿å­˜å¯¹è¯è®°å½•åˆ°æŒ‡å®šæ–‡ä»¶å¤¹
- **è¯­éŸ³æ‰“æ–­**: æ”¯æŒè¯­éŸ³æ‰“æ–­TTSæ’­æ”¾
- **è‡ªå®šä¹‰æç¤ºè¯**: æ”¯æŒè§¦å‘è¯æ¿€æ´»ç‰¹å®šæç¤ºæ¨¡æ¿

### 7. è¯­éŸ³å¬å†™æ¨¡å—
- **æ ¸å¿ƒæ–¹æ³•**: `startVoiceDictation()`, `startContinuousDictation()`
- **åŠŸèƒ½**: è¿ç»­è¯­éŸ³è½¬æ–‡å­—ï¼Œè‡ªåŠ¨æ’å…¥å½“å‰ç¬”è®°
- **é™é»˜æ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹è¯­éŸ³åœé¡¿ï¼Œåˆ†æ®µå¤„ç†
- **å®æ—¶æ’å…¥**: è¯†åˆ«ç»“æœå®æ—¶æ’å…¥å…‰æ ‡ä½ç½®

### 8. è®¾ç½®ç•Œé¢æ¨¡å—
- **ç±»å**: `VoiceAssistantSettingTab`
- **åŠŸèƒ½**: æä¾›å›¾å½¢åŒ–é…ç½®ç•Œé¢
- **é…ç½®é¡¹**: åŒ…å«æ‰€æœ‰åŠŸèƒ½çš„è¯¦ç»†é…ç½®é€‰é¡¹

## è¿è¡Œç¯å¢ƒè¦æ±‚

### åŸºç¡€ç¯å¢ƒ
- **Obsidian**: ç‰ˆæœ¬ 0.15.0 æˆ–æ›´é«˜
- **æ“ä½œç³»ç»Ÿ**: Windowsã€macOSã€Linux (ä»…æ¡Œé¢ç‰ˆ)
- **ç½‘ç»œè¿æ¥**: éœ€è¦ç¨³å®šçš„äº’è”ç½‘è¿æ¥ï¼ˆç”¨äºåœ¨çº¿è¯­éŸ³æœåŠ¡å’ŒAIæ¨¡å‹è°ƒç”¨ï¼‰

### å¼€å‘ç¯å¢ƒ
- **Node.js**: 16.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- **npm**: 6.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- **TypeScript**: 4.7.4
- **ESBuild**: 0.17.3

### ä¾èµ–åº“
```json
{
  "dependencies": {
    "crypto-js": "^4.2.0",
    "ws": "^8.18.3"
  },
  "devDependencies": {
    "@types/crypto-js": "^4.2.2",
    "@types/node": "^16.11.6",
    "typescript": "4.7.4",
    "esbuild": "0.17.3",
    "obsidian": "latest"
  }
}
```

## å®‰è£…æ­¥éª¤

### æ–¹æ³•ä¸€ï¼šæ‰‹åŠ¨å®‰è£…
1. **ä¸‹è½½æ’ä»¶æ–‡ä»¶**
   ```bash
   git clone https://github.com/yuhanbo/obsidian-yuhanbo-voice_assistant.git
   ```

2. **å®‰è£…ä¾èµ–**
   ```bash
   cd obsidian-yuhanbo-voice_assistant
   npm install
   ```

3. **ç¼–è¯‘æ’ä»¶**
   ```bash
   npm run build
   ```

4. **å¤åˆ¶åˆ°Obsidianæ’ä»¶ç›®å½•**
   ```bash
   # å°†æ•´ä¸ªæ–‡ä»¶å¤¹å¤åˆ¶åˆ°ï¼š
   # Windows: %APPDATA%\Obsidian\plugins\
   # macOS: ~/Library/Application Support/obsidian/plugins/
   # Linux: ~/.config/obsidian/plugins/
   ```

### æ–¹æ³•äºŒï¼šå¼€å‘æ¨¡å¼å®‰è£…
1. **å…‹éš†åˆ°Obsidianæ’ä»¶ç›®å½•**
   ```bash
   cd /path/to/obsidian/vault/.obsidian/plugins/
   git clone https://github.com/yuhanbo/obsidian-yuhanbo-voice_assistant.git
   ```

2. **å®‰è£…å¹¶æ„å»º**
   ```bash
   cd obsidian-yuhanbo-voice_assistant
   npm install
   npm run build
   ```

3. **åœ¨Obsidianä¸­å¯ç”¨æ’ä»¶**
   - æ‰“å¼€ Obsidian è®¾ç½®
   - è¿›å…¥"ç¬¬ä¸‰æ–¹æ’ä»¶"
   - æ‰¾åˆ°"è¯­éŸ³åŠ©æ‰‹ (Voice Assistant)"
   - ç‚¹å‡»å¯ç”¨

## é…ç½®è¯´æ˜

### åŸºç¡€é…ç½®æ–‡ä»¶ (data.json)

```json
{
  "llmProvider": "xunfei",           // å¤§è¯­è¨€æ¨¡å‹æä¾›å•†
  "wakeMode": "online",              // å”¤é†’æ¨¡å¼ï¼šonline/disabled
  "wakeWords": [                     // è‡ªå®šä¹‰å”¤é†’è¯
    "ä½ å¥½ï¼Œå°ä¸‰",
    "å°ä¸‰åŒå­¦", 
    "å°ä¸‰å°ä¸‰"
  ],
  "ttsMode": "online",               // TTSæ¨¡å¼ï¼šonline/disabled
  "asrProvider": "xunfei",           // ASRæä¾›å•†
  "enableDebugLog": true             // æ˜¯å¦å¯ç”¨è°ƒè¯•æ—¥å¿—
}
```

### è¯¦ç»†é…ç½®é¡¹è¯´æ˜

#### 1. å¤§è¯­è¨€æ¨¡å‹é…ç½®
```typescript
interface LLMConfig {
  llmProvider: 'google' | 'openrouter' | 'xunfei' | 'custom';
  googleApiKey: string;              // Google AI Studio APIå¯†é’¥
  googleModel: string;               // Googleæ¨¡å‹åç§°
  openrouterApiKey: string;          // OpenRouter APIå¯†é’¥
  openrouterModel: string;           // OpenRouteræ¨¡å‹åç§°
  xunfeiAppId: string;               // è®¯é£åº”ç”¨ID
  xunfeiApiKey: string;              // è®¯é£APIå¯†é’¥
  xunfeiApiSecret: string;           // è®¯é£APIå¯†é’¥
  xunfeiModel: string;               // è®¯é£æ¨¡å‹ç‰ˆæœ¬
}
```

#### 2. è¯­éŸ³åŠŸèƒ½é…ç½®
```typescript
interface VoiceConfig {
  // è¯­éŸ³è¯†åˆ«
  asrProvider: 'xunfei';
  
  // è¯­éŸ³åˆæˆ
  ttsMode: 'disabled' | 'online';
  ttsProvider: 'xunfei';
  ttsVoice: string;                  // éŸ³è‰²é€‰æ‹©
  ttsSpeed: number;                  // è¯­é€Ÿ (0-100)
  ttsVolume: number;                 // éŸ³é‡ (0-100)
  ttsPitch: number;                  // éŸ³è°ƒ (0-100)
  
  // è¯­éŸ³å”¤é†’
  wakeMode: 'online' | 'disabled';
  wakeWords: string[];               // å”¤é†’è¯åˆ—è¡¨
  autoEnterDialogAfterWake: boolean; // å”¤é†’åè‡ªåŠ¨è¿›å…¥å¯¹è¯
  wakeDetectionInterval: number;     // æ£€æµ‹é—´éš”(æ¯«ç§’)
}
```

#### 3. å¯¹è¯åŠŸèƒ½é…ç½®
```typescript
interface DialogConfig {
  continuousDialogDuration: number;     // æŒç»­å¯¹è¯æ—¶é•¿(ç§’)
  showDialogControls: boolean;          // æ˜¾ç¤ºå¯¹è¯æ§åˆ¶ç•Œé¢
  conversationSaveFolder: string;       // å¯¹è¯ä¿å­˜æ–‡ä»¶å¤¹
  enableVoiceInterruption: boolean;     // å¯ç”¨è¯­éŸ³æ‰“æ–­
  customPrompts: Array<{                // è‡ªå®šä¹‰æç¤ºè¯
    name: string;
    trigger: string;
    prompt: string;
    enabled: boolean;
  }>;
}
```

## ä½¿ç”¨æ–¹æ³•

### 1. åŸºç¡€è¯­éŸ³å¯¹è¯
```typescript
// é€šè¿‡å‘½ä»¤é¢æ¿å¯åŠ¨
// 1. æŒ‰ Ctrl+P (Cmd+P) æ‰“å¼€å‘½ä»¤é¢æ¿
// 2. è¾“å…¥ "å¼€å§‹å¯¹è¯"
// 3. ç‚¹å‡»å¼€å§‹è¯­éŸ³å¯¹è¯

// æˆ–é€šè¿‡ä»£ç è°ƒç”¨
this.startVoiceConversation();
```

### 2. è¯­éŸ³å”¤é†’ä½¿ç”¨
```typescript
// é…ç½®å”¤é†’è¯
const wakeWords = ["ä½ å¥½ï¼Œå°ä¸‰", "å°ä¸‰åŒå­¦", "å°ä¸‰å°ä¸‰"];

// å¯åŠ¨å”¤é†’ç›‘å¬
this.startWakeListening();

// è¯´å‡ºå”¤é†’è¯åè‡ªåŠ¨æ¿€æ´»å¯¹è¯
// æ— éœ€æ‰‹åŠ¨æ“ä½œï¼Œæ’ä»¶ä¼šè‡ªåŠ¨å“åº”
```

### 3. è¯­éŸ³å¬å†™åŠŸèƒ½
```typescript
// å¯åŠ¨è¯­éŸ³å¬å†™
this.startVoiceDictation();

// æŒç»­å¬å†™æ¨¡å¼
this.startContinuousDictation();

// å¬å†™å†…å®¹ä¼šè‡ªåŠ¨æ’å…¥åˆ°å½“å‰å…‰æ ‡ä½ç½®
```

### 4. è¯­éŸ³æœ—è¯»åŠŸèƒ½
```typescript
// é€‰ä¸­æ–‡æœ¬åå¯åŠ¨æœ—è¯»
this.startVoiceReading();

// æ”¯æŒæš‚åœ/ç»§ç»­/åœæ­¢æ§åˆ¶
this.toggleTTSPlayback();  // æš‚åœ/ç»§ç»­
this.stopTTS();            // åœæ­¢æœ—è¯»
```

### 5. è‡ªå®šä¹‰æç¤ºè¯ä½¿ç”¨
```typescript
// åœ¨å¯¹è¯ä¸­ä½¿ç”¨è§¦å‘è¯
// ä¾‹å¦‚ï¼šè¯´ "æé†’æˆ‘æ˜å¤©å¼€ä¼š"
// ä¼šè‡ªåŠ¨åº”ç”¨"ä»»åŠ¡æé†’"æç¤ºè¯æ¨¡æ¿
```

### 6. æµ‹è¯•åŠŸèƒ½
æ’ä»¶æä¾›äº†å¤šä¸ªæµ‹è¯•æ–¹æ³•ï¼Œå¯åœ¨è®¾ç½®ç•Œé¢çš„"æµ‹è¯•åŠŸèƒ½"åŒºåŸŸä½¿ç”¨ï¼š

```typescript
// æµ‹è¯•è¯­éŸ³è¯†åˆ«
await this.testOnlineASR();

// æµ‹è¯•è¯­éŸ³åˆæˆ
await this.testOnlineTTS();

// æµ‹è¯•æ‰€æœ‰éŸ³è‰²
await this.testAllVoiceSpeakers();

// è°ƒè¯•TTSè¿æ¥
await this.debugTTSConnection();
```

## APIæ¥å£è¯´æ˜

### æ ¸å¿ƒAPIæ–¹æ³•

#### 1. è¯­éŸ³è¯†åˆ«API
```typescript
/**
 * è¯­éŸ³è½¬æ–‡å­—
 * @param audioBlob éŸ³é¢‘æ•°æ®
 * @returns Promise<string> è¯†åˆ«ç»“æœ
 */
async speechToText(audioBlob: Blob): Promise<string>

/**
 * è®¯é£åœ¨çº¿ASR
 * @param audioBlob éŸ³é¢‘æ•°æ®  
 * @returns Promise<string> è¯†åˆ«ç»“æœ
 */
async xunfeiOnlineASR(audioBlob: Blob): Promise<string>
```

#### 2. è¯­éŸ³åˆæˆAPI
```typescript
/**
 * æ–‡å­—è½¬è¯­éŸ³
 * @param text è¦åˆæˆçš„æ–‡å­—
 * @returns Promise<void>
 */
async textToSpeech(text: string): Promise<void>

/**
 * è®¯é£åœ¨çº¿TTS
 * @param text è¦åˆæˆçš„æ–‡å­—
 * @returns Promise<void>
 */
async xunfeiOnlineTTS(text: string): Promise<void>
```

#### 3. å¤§è¯­è¨€æ¨¡å‹API
```typescript
/**
 * è°ƒç”¨å¤§è¯­è¨€æ¨¡å‹
 * @param text ç”¨æˆ·è¾“å…¥æ–‡æœ¬
 * @returns Promise<string> AIå›å¤
 */
async callLLM(text: string): Promise<string>

/**
 * è°ƒç”¨Google AI
 * @param text ç”¨æˆ·è¾“å…¥
 * @returns Promise<string> AIå›å¤
 */
async callGoogleAI(text: string): Promise<string>

/**
 * è°ƒç”¨è®¯é£æ˜Ÿç«
 * @param text ç”¨æˆ·è¾“å…¥
 * @returns Promise<string> AIå›å¤  
 */
async callXunfeiSpark(text: string): Promise<string>
```

#### 4. å”¤é†’ç›‘å¬API
```typescript
/**
 * å¯åŠ¨è¯­éŸ³å”¤é†’ç›‘å¬
 */
startWakeListening(): void

/**
 * åœæ­¢è¯­éŸ³å”¤é†’ç›‘å¬
 */
stopWakeListening(): void

/**
 * å”¤é†’è¯æ£€æµ‹å›è°ƒ
 */
async onWakeWordDetected(): Promise<void>
```

### äº‹ä»¶å›è°ƒ

#### 1. å½•éŸ³äº‹ä»¶
```typescript
// å½•éŸ³å¼€å§‹
mediaRecorder.onstart = () => {
  this.updateStatusFloat('ğŸ¤ æ­£åœ¨å½•éŸ³...', 'info');
};

// å½•éŸ³æ•°æ®å¯ç”¨
mediaRecorder.ondataavailable = (event: BlobEvent) => {
  if (event.data.size > 0) {
    this.audioChunks.push(event.data);
  }
};

// å½•éŸ³åœæ­¢
mediaRecorder.onstop = () => {
  // å¤„ç†å½•éŸ³æ•°æ®
};
```

#### 2. WebSocketäº‹ä»¶
```typescript
// TTS WebSocketè¿æ¥
ws.onopen = () => {
  console.log('TTS WebSocketè¿æ¥å·²å»ºç«‹');
};

ws.onmessage = (event: MessageEvent) => {
  // å¤„ç†TTSéŸ³é¢‘æ•°æ®
};

ws.onerror = (error) => {
  console.error('TTS WebSocketé”™è¯¯:', error);
};
```

## å¸¸è§é—®é¢˜è§£ç­”

### Q1: æ’ä»¶æ— æ³•å¯åŠ¨æˆ–åŠ è½½å¤±è´¥ï¼Ÿ
**A**: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. ç¡®ä¿Obsidianç‰ˆæœ¬ â‰¥ 0.15.0
2. æ£€æŸ¥æ’ä»¶æ–‡ä»¶æ˜¯å¦å®Œæ•´
3. æŸ¥çœ‹æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
4. å°è¯•é‡æ–°ç¼–è¯‘æ’ä»¶ï¼š`npm run build`

### Q2: è¯­éŸ³è¯†åˆ«ä¸å‡†ç¡®æˆ–æ— å“åº”ï¼Ÿ
**A**: å¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼š
1. æ£€æŸ¥éº¦å…‹é£æƒé™æ˜¯å¦å·²æˆäºˆ
2. ç¡®ä¿ç½‘ç»œè¿æ¥ç¨³å®š
3. éªŒè¯è®¯é£APIå¯†é’¥æ˜¯å¦æ­£ç¡®é…ç½®
4. å°è¯•è°ƒæ•´å½•éŸ³å‚æ•°ï¼ˆé‡‡æ ·ç‡ã€å£°é“æ•°ï¼‰
5. åœ¨å®‰é™ç¯å¢ƒä¸­æµ‹è¯•

### Q3: è¯­éŸ³åˆæˆæ— å£°éŸ³æˆ–æ’­æ”¾å¤±è´¥ï¼Ÿ
**A**: æ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥ç³»ç»ŸéŸ³é‡è®¾ç½®
2. éªŒè¯è®¯é£TTSé…ç½®æ˜¯å¦æ­£ç¡®
3. å°è¯•ä¸åŒçš„éŸ³è‰²è®¾ç½®
4. æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€
5. æŸ¥çœ‹è°ƒè¯•æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯

### Q4: å”¤é†’åŠŸèƒ½ä¸å·¥ä½œï¼Ÿ
**A**: æ£€æŸ¥é…ç½®ï¼š
1. ç¡®ä¿ `wakeMode` è®¾ç½®ä¸º `"online"`
2. æ£€æŸ¥å”¤é†’è¯æ˜¯å¦æ­£ç¡®é…ç½®
3. éªŒè¯éº¦å…‹é£æƒé™
4. è°ƒæ•´å”¤é†’æ£€æµ‹é—´éš”
5. åœ¨å®‰é™ç¯å¢ƒä¸­æ¸…æ™°è¯´å‡ºå”¤é†’è¯

### Q5: å¤§è¯­è¨€æ¨¡å‹è°ƒç”¨å¤±è´¥ï¼Ÿ
**A**: éªŒè¯é…ç½®ï¼š
1. æ£€æŸ¥å¯¹åº”çš„APIå¯†é’¥æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤APIé…é¢æ˜¯å¦å……è¶³
3. éªŒè¯ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®
4. å°è¯•åˆ‡æ¢ä¸åŒçš„æ¨¡å‹æä¾›å•†
5. æŸ¥çœ‹è°ƒè¯•æ—¥å¿—è·å–å…·ä½“é”™è¯¯ä¿¡æ¯

### Q6: å¦‚ä½•è‡ªå®šä¹‰å”¤é†’è¯ï¼Ÿ
**A**: åœ¨è®¾ç½®ç•Œé¢ä¸­ï¼š
1. è¿›å…¥"è¯­éŸ³å”¤é†’é…ç½®"éƒ¨åˆ†
2. åœ¨"å”¤é†’è¯ç®¡ç†"ä¸­æ·»åŠ æ–°çš„å”¤é†’è¯
3. å»ºè®®ä½¿ç”¨3-5ä¸ªå­—çš„æ¸…æ™°è¯è¯­
4. é¿å…ä½¿ç”¨è¿‡äºå¸¸è§çš„è¯æ±‡

### Q7: å¦‚ä½•æ·»åŠ è‡ªå®šä¹‰æç¤ºè¯ï¼Ÿ
**A**: é…ç½®æ­¥éª¤ï¼š
1. è¿›å…¥æ’ä»¶è®¾ç½®çš„"è‡ªå®šä¹‰æç¤ºè¯"éƒ¨åˆ†
2. ç‚¹å‡»"æ·»åŠ æ–°æç¤ºè¯"
3. è®¾ç½®è§¦å‘å…³é”®è¯å’Œæç¤ºå†…å®¹
4. å¯ç”¨è¯¥æç¤ºè¯
5. åœ¨å¯¹è¯ä¸­ä½¿ç”¨è§¦å‘è¯å³å¯æ¿€æ´»

### Q8: æ’ä»¶å ç”¨èµ„æºè¿‡å¤šï¼Ÿ
**A**: ä¼˜åŒ–å»ºè®®ï¼š
1. è°ƒæ•´å”¤é†’æ£€æµ‹é—´éš”ï¼ˆå¢å¤§æ•°å€¼ï¼‰
2. å…³é—­ä¸éœ€è¦çš„åŠŸèƒ½ï¼ˆå¦‚è¯­éŸ³å”¤é†’ï¼‰
3. é™ä½éŸ³é¢‘é‡‡æ ·ç‡
4. å…³é—­è°ƒè¯•æ—¥å¿—
5. å®šæœŸæ¸…ç†å¯¹è¯å†å²æ–‡ä»¶

### Q9: å¦‚ä½•å¤‡ä»½å’Œæ¢å¤é…ç½®ï¼Ÿ
**A**: é…ç½®ç®¡ç†ï¼š
1. å¤‡ä»½ï¼šå¤åˆ¶ `data.json` æ–‡ä»¶
2. æ¢å¤ï¼šå°†å¤‡ä»½çš„ `data.json` æ–‡ä»¶è¦†ç›–å½“å‰é…ç½®
3. é‡å¯Obsidianä½¿é…ç½®ç”Ÿæ•ˆ
4. å»ºè®®å®šæœŸå¤‡ä»½é‡è¦é…ç½®

### Q10: å¦‚ä½•æ›´æ–°æ’ä»¶ï¼Ÿ
**A**: æ›´æ–°æ­¥éª¤ï¼š
1. å¤‡ä»½å½“å‰é…ç½®æ–‡ä»¶ `data.json`
2. ä¸‹è½½æœ€æ–°ç‰ˆæœ¬æ’ä»¶ä»£ç 
3. è¿è¡Œ `npm install && npm run build`
4. æ¢å¤é…ç½®æ–‡ä»¶
5. é‡å¯Obsidian

## å¼€å‘è€…æŒ‡å—

### é¡¹ç›®æ¶æ„

#### 1. æ ¸å¿ƒç±»ç»“æ„
```typescript
// ä¸»æ’ä»¶ç±»
export default class VoiceAssistantPlugin extends Plugin {
  // é…ç½®ç®¡ç†
  settings: VoiceAssistantSettings;
  
  // éŸ³é¢‘å¤„ç†
  private mediaRecorder: MediaRecorder | null;
  private wakeMediaRecorder: MediaRecorder | null;
  
  // çŠ¶æ€ç®¡ç†
  private isRecording: boolean;
  private isListening: boolean;
  private isInContinuousDialog: boolean;
  
  // UIç»„ä»¶
  private statusFloat: HTMLElement | null;
}
```

#### 2. è®¾ç½®ç•Œé¢ç±»
```typescript
class VoiceAssistantSettingTab extends PluginSettingTab {
  plugin: VoiceAssistantPlugin;
  
  constructor(app: App, plugin: VoiceAssistantPlugin);
  display(): void;  // æ¸²æŸ“è®¾ç½®ç•Œé¢
}
```

### å¼€å‘ç¯å¢ƒæ­å»º

#### 1. å…‹éš†é¡¹ç›®
```bash
git clone https://github.com/yuhanbo/obsidian-yuhanbo-voice_assistant.git
cd obsidian-yuhanbo-voice_assistant
```

#### 2. å®‰è£…ä¾èµ–
```bash
npm install
```

#### 3. å¼€å‘æ¨¡å¼
```bash
# ç›‘å¬æ–‡ä»¶å˜åŒ–ï¼Œè‡ªåŠ¨ç¼–è¯‘
npm run dev

# æ‰‹åŠ¨ç¼–è¯‘
npm run build
```

#### 4. è°ƒè¯•æŠ€å·§
```typescript
// å¯ç”¨è°ƒè¯•æ—¥å¿—
this.settings.enableDebugLog = true;

// ä½¿ç”¨è°ƒè¯•æ–¹æ³•
this.debugLog('è°ƒè¯•ä¿¡æ¯', data);

// æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹æ—¥å¿—
// æ‰“å¼€ Obsidian å¼€å‘è€…å·¥å…· (Ctrl+Shift+I)
```

### æ‰©å±•å¼€å‘

#### 1. æ·»åŠ æ–°çš„è¯­éŸ³æœåŠ¡æä¾›å•†
```typescript
// 1. æ‰©å±•é…ç½®æ¥å£
interface VoiceAssistantSettings {
  asrProvider: 'xunfei' | 'newProvider';
  ttsProvider: 'xunfei' | 'newProvider';
}

// 2. å®ç°æ–°çš„ASRæ–¹æ³•
async newProviderASR(audioBlob: Blob): Promise<string> {
  // å®ç°æ–°çš„è¯­éŸ³è¯†åˆ«é€»è¾‘
}

// 3. å®ç°æ–°çš„TTSæ–¹æ³•
async newProviderTTS(text: string): Promise<void> {
  // å®ç°æ–°çš„è¯­éŸ³åˆæˆé€»è¾‘
}

// 4. åœ¨ä¸»æ–¹æ³•ä¸­æ·»åŠ åˆ†æ”¯
async speechToText(audioBlob: Blob): Promise<string> {
  switch (this.settings.asrProvider) {
    case 'xunfei':
      return await this.xunfeiOnlineASR(audioBlob);
    case 'newProvider':
      return await this.newProviderASR(audioBlob);
  }
}
```

#### 2. æ·»åŠ æ–°çš„å¤§è¯­è¨€æ¨¡å‹
```typescript
// 1. æ‰©å±•LLMæä¾›å•†ç±»å‹
type LLMProvider = 'google' | 'openrouter' | 'xunfei' | 'newLLM';

// 2. å®ç°æ–°çš„LLMè°ƒç”¨æ–¹æ³•
async callNewLLM(text: string): Promise<string> {
  // å®ç°æ–°çš„å¤§è¯­è¨€æ¨¡å‹è°ƒç”¨é€»è¾‘
}

// 3. åœ¨ä¸»è°ƒç”¨æ–¹æ³•ä¸­æ·»åŠ åˆ†æ”¯
async callLLM(text: string): Promise<string> {
  switch (this.settings.llmProvider) {
    case 'newLLM':
      return await this.callNewLLM(text);
    // ... å…¶ä»–åˆ†æ”¯
  }
}
```

#### 3. è‡ªå®šä¹‰UIç»„ä»¶
```typescript
// åˆ›å»ºè‡ªå®šä¹‰çŠ¶æ€æ˜¾ç¤º
private createCustomStatusDisplay(): HTMLElement {
  const container = document.createElement('div');
  container.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--background-primary);
    border: 1px solid var(--background-modifier-border);
    border-radius: 8px;
    padding: 12px;
    z-index: 1000;
  `;
  
  return container;
}
```

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### 1. éŸ³é¢‘å¤„ç†ä¼˜åŒ–
```typescript
// ä½¿ç”¨Web Workerså¤„ç†éŸ³é¢‘
const worker = new Worker('audio-processor.js');
worker.postMessage({ audioData: audioBlob });

// éŸ³é¢‘å‹ç¼©
const compressedAudio = await this.compressAudio(audioBlob);
```

#### 2. å†…å­˜ç®¡ç†
```typescript
// åŠæ—¶æ¸…ç†éŸ³é¢‘èµ„æº
private cleanupAudioResources(): void {
  if (this.currentAudio) {
    this.currentAudio.pause();
    this.currentAudio = null;
  }
  
  this.audioChunks = [];
  this.dictationAudioChunks = [];
}
```

#### 3. ç½‘ç»œè¯·æ±‚ä¼˜åŒ–
```typescript
// æ·»åŠ è¯·æ±‚é‡è¯•æœºåˆ¶
async retryRequest<T>(
  requestFn: () => Promise<T>, 
  maxRetries: number = 3
): Promise<T> {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await requestFn();
    } catch (error) {
      if (i === maxRetries - 1) throw error;
      await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
    }
  }
}
```

### æµ‹è¯•æŒ‡å—

#### 1. å•å…ƒæµ‹è¯•
```typescript
// æµ‹è¯•è¯­éŸ³è¯†åˆ«åŠŸèƒ½
describe('è¯­éŸ³è¯†åˆ«æµ‹è¯•', () => {
  test('åº”è¯¥æ­£ç¡®è¯†åˆ«éŸ³é¢‘', async () => {
    const mockAudio = new Blob(['test'], { type: 'audio/wav' });
    const result = await plugin.speechToText(mockAudio);
    expect(result).toBeDefined();
  });
});
```

#### 2. é›†æˆæµ‹è¯•
```typescript
// æµ‹è¯•å®Œæ•´å¯¹è¯æµç¨‹
describe('å¯¹è¯æµç¨‹æµ‹è¯•', () => {
  test('åº”è¯¥å®Œæˆå®Œæ•´çš„è¯­éŸ³å¯¹è¯', async () => {
    await plugin.startVoiceConversation();
    // æ¨¡æ‹Ÿç”¨æˆ·è¯­éŸ³è¾“å…¥
    // éªŒè¯AIå“åº”
    // éªŒè¯TTSæ’­æ”¾
  });
});
```

### å‘å¸ƒæµç¨‹

#### 1. ç‰ˆæœ¬æ›´æ–°
```bash
# æ›´æ–°ç‰ˆæœ¬å·
npm run version

# æäº¤æ›´æ”¹
git add .
git commit -m "Release v1.x.x"
git tag v1.x.x
git push origin main --tags
```

#### 2. æ„å»ºå‘å¸ƒç‰ˆæœ¬
```bash
# ç”Ÿäº§ç¯å¢ƒæ„å»º
npm run build

# æ£€æŸ¥æ„å»ºæ–‡ä»¶
ls -la main.js manifest.json styles.css
```

#### 3. å‘å¸ƒåˆ°Obsidianç¤¾åŒº
1. åˆ›å»ºGitHub Release
2. ä¸Šä¼ æ„å»ºæ–‡ä»¶
3. æäº¤åˆ°Obsidianæ’ä»¶å¸‚åœº
4. æ›´æ–°æ–‡æ¡£å’Œè¯´æ˜

---

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

## è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤Issueå’ŒPull Requestæ¥æ”¹è¿›è¿™ä¸ªé¡¹ç›®ã€‚åœ¨è´¡çŒ®ä»£ç å‰ï¼Œè¯·ç¡®ä¿ï¼š

1. éµå¾ªç°æœ‰çš„ä»£ç é£æ ¼
2. æ·»åŠ é€‚å½“çš„æ³¨é‡Šå’Œæ–‡æ¡£
3. è¿›è¡Œå……åˆ†çš„æµ‹è¯•
4. æ›´æ–°ç›¸å…³æ–‡æ¡£




## ğŸ‘¨â€ğŸ’» ä½œè€…ä¿¡æ¯

**ä½™æ±‰æ³¢** - ç¼–ç¨‹çˆ±å¥½è€…-é‡åŒ–äº¤æ˜“å’Œæ•ˆç‡å·¥å…·å¼€å‘

- **GitHub**: [@yuhanbo758](https://github.com/yuhanbo758)

- **Email**: yuhanbo@sanrenjz.com

- **Website**: [ä¸‰äººèšæ™º](https://www.sanrenjz.com)

## ğŸŒ ç›¸å…³é“¾æ¥

- ğŸ  [é¡¹ç›®ä¸»é¡µ](https://www.sanrenjz.com)

- ğŸ“š [åœ¨çº¿æ–‡æ¡£](https://docs.sanrenjz.com)ï¼ˆè´¢ç»ã€ä»£ç å’Œåº“æ–‡æ¡£ç­‰ï¼‰

- ğŸ›’ [æ’ä»¶å•†åº—](https://shop.sanrenjz.com)ï¼ˆä¸ªäººå¼€å‘çš„æ‰€æœ‰ç¨‹åºï¼ŒåŒ…æ‹¬å¼€æºå’Œä¸å¼€æºï¼‰


## è”ç³»æˆ‘ä»¬

[è”ç³»æˆ‘ä»¬ - ä¸‰äººèšæ™º-ä½™æ±‰æ³¢](https://www.sanrenjz.com/contact_us/)

python ç¨‹åºç®¡ç†å·¥å…·ä¸‹è½½ï¼š[sanrenjz - ä¸‰äººèšæ™º-ä½™æ±‰æ³¢](https://www.sanrenjz.com/sanrenjz/)

æ•ˆç‡å·¥å…·ç¨‹åºç®¡ç†ä¸‹è½½ï¼š[sanrenjz-tools - ä¸‰äººèšæ™º-ä½™æ±‰æ³¢](https://www.sanrenjz.com/sanrenjz-tools/)

![ä¸‰ç åˆä¸€](https://gdsx.sanrenjz.com/image/sanrenjz_yuhanbolh_yuhanbo758.png?imageSlim&t=1ab9b82c-e220-8022-beff-e265a194292a)

![ä½™æ±‰æ³¢æ‰“èµç ](https://gdsx.sanrenjz.com/image/%E6%89%93%E8%B5%8F%E7%A0%81%E5%90%88%E4%B8%80.png?imageSlim)

## ğŸ™ è‡´è°¢

æ„Ÿè°¢æ‰€æœ‰ä¸ºæœ¬é¡¹ç›®è´¡çŒ®ä»£ç å’Œæƒ³æ³•çš„å¼€å‘è€…ä»¬ï¼

---
**â­ å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·ç»™å®ƒä¸€ä¸ª Starï¼**



